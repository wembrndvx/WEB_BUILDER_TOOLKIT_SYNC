<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPS - Preview (기획서 v.0.8_260128)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f1219;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .preview-controls { display: flex; gap: 12px; }

        .preview-btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .preview-btn:hover { background: #2563eb; }
        .preview-btn.warning { background: #eab308; color: #000; }
        .preview-btn.critical { background: #ef4444; }
        .preview-btn.destroy { background: #6b7280; }
        .preview-btn.destroy:hover { background: #4b5563; }

        .instance-info { font-size: 12px; color: #6b7280; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="preview-controls">
        <button class="preview-btn" onclick="showNormal()">Normal UPS</button>
        <button class="preview-btn warning" onclick="showWarning()">Warning UPS</button>
        <button class="preview-btn critical" onclick="showCritical()">Critical UPS</button>
        <button class="preview-btn destroy" onclick="destroyInstance()">Destroy</button>
    </div>
    <div class="instance-info" id="instance-info">Instance: not created</div>

    <div id="popup-host"></div>

    <script>
        // ======================
        // TEMPLATE DATA (기획서 v.0.8_260128 기준)
        // ======================
        const htmlCode = `
            <template id="popup-ups">
                <div class="popup-overlay">
                    <div class="popup-content">
                        <div class="popup-header">
                            <div class="header-info">
                                <h2 class="ups-name">-</h2>
                                <span class="ups-zone">-</span>
                            </div>
                            <div class="header-actions">
                                <span class="ups-status" data-status="normal">Normal</span>
                                <button class="close-btn" type="button" aria-label="Close">
                                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="popup-body">
                            <!-- Section 1: 기본정보 -->
                            <div class="section info-section">
                                <div class="section-header">
                                    <span class="section-title">기본정보</span>
                                </div>
                                <div class="info-content">
                                    <div class="info-layout">
                                        <div class="info-image-placeholder">
                                            <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                                <rect x="8" y="6" width="32" height="36" rx="2" stroke="#4b5563" stroke-width="2"/>
                                                <rect x="12" y="10" width="8" height="4" fill="#4b5563"/>
                                                <rect x="28" y="10" width="8" height="4" fill="#4b5563"/>
                                                <rect x="14" y="18" width="20" height="8" rx="1" stroke="#4b5563" stroke-width="1.5"/>
                                                <line x1="14" y1="22" x2="22" y2="22" stroke="#22c55e" stroke-width="2"/>
                                                <rect x="14" y="30" width="20" height="8" rx="1" stroke="#4b5563" stroke-width="1.5"/>
                                                <line x1="14" y1="34" x2="20" y2="34" stroke="#3b82f6" stroke-width="2"/>
                                            </svg>
                                            <span class="image-label">UPS</span>
                                        </div>
                                        <table class="info-table">
                                            <tbody>
                                                <tr><th>자산명</th><td class="info-name">-</td></tr>
                                                <tr><th>자산타입</th><td class="info-type">-</td></tr>
                                                <tr><th>용도</th><td class="info-usage">-</td></tr>
                                                <tr><th>제조사명</th><td class="info-vendor">-</td></tr>
                                                <tr><th>모델</th><td class="info-model">-</td></tr>
                                                <tr><th>위치</th><td class="info-location">-</td></tr>
                                                <tr><th>상태</th><td class="info-status">-</td></tr>
                                                <tr><th>설치일</th><td class="info-install-date">-</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 2: UPS 전력현황 (4카드) -->
                            <div class="section power-section">
                                <div class="section-header">
                                    <span class="section-title">UPS 전력현황</span>
                                    <span class="section-timestamp"></span>
                                </div>
                                <div class="power-cards">
                                    <div class="power-card" data-metric="batterySoc">
                                        <div class="power-card-label"></div>
                                        <div class="power-card-body">
                                            <span class="power-card-value">-</span>
                                            <span class="power-card-unit"></span>
                                        </div>
                                    </div>
                                    <div class="power-card" data-metric="batteryTime">
                                        <div class="power-card-label"></div>
                                        <div class="power-card-body">
                                            <span class="power-card-value">-</span>
                                            <span class="power-card-unit"></span>
                                        </div>
                                    </div>
                                    <div class="power-card" data-metric="loadRate">
                                        <div class="power-card-label"></div>
                                        <div class="power-card-body">
                                            <span class="power-card-value">-</span>
                                            <span class="power-card-unit"></span>
                                        </div>
                                    </div>
                                    <div class="power-card" data-metric="batteryVolt">
                                        <div class="power-card-label"></div>
                                        <div class="power-card-body">
                                            <span class="power-card-value">-</span>
                                            <span class="power-card-unit"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Section 3: UPS 입/출력 추이 (3탭 트렌드 차트) -->
                            <div class="section chart-section">
                                <div class="section-header">
                                    <span class="section-title">UPS 입/출력 추이</span>
                                </div>
                                <div class="tab-header">
                                    <button class="tab-btn" data-tab="current"></button>
                                    <button class="tab-btn active" data-tab="voltage"></button>
                                    <button class="tab-btn" data-tab="frequency"></button>
                                </div>
                                <div class="chart-legend">
                                    <span class="legend-item legend-input"><span class="legend-dot"></span><span class="legend-label"></span></span>
                                    <span class="legend-item legend-output"><span class="legend-dot"></span><span class="legend-label"></span></span>
                                </div>
                                <div class="chart-container"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </template>
        `;

        const cssCode = `
            .popup-overlay { position: absolute; top: 0; right: 0; height: 100%; pointer-events: none; z-index: 1000; }
            .popup-content { background: #1a1f2e; border-radius: 12px 0 0 12px; width: 560px; height: 100%; overflow: hidden; box-shadow: -4px 0 24px rgba(0,0,0,0.4); border: 1px solid #2a3142; border-right: none; display: flex; flex-direction: column; pointer-events: auto; }
            .popup-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #2a3142; flex-shrink: 0; }
            .header-info { display: flex; flex-direction: column; gap: 4px; }
            .ups-name { margin: 0; font-size: 18px; font-weight: 600; color: #e0e6ed; }
            .ups-zone { font-size: 13px; color: #8892a0; }
            .header-actions { display: flex; align-items: center; gap: 12px; }
            .ups-status { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
            .ups-status[data-status="normal"] { background: rgba(34,197,94,0.15); color: #22c55e; }
            .ups-status[data-status="warning"] { background: rgba(234,179,8,0.15); color: #eab308; }
            .ups-status[data-status="critical"] { background: rgba(239,68,68,0.15); color: #ef4444; }
            .close-btn { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; padding: 0; background: transparent; border: none; border-radius: 6px; color: #8892a0; cursor: pointer; transition: background 0.15s, color 0.15s; }
            .close-btn:hover { background: #2a3142; color: #e0e6ed; }
            .popup-body { padding: 20px 24px; display: flex; flex-direction: column; gap: 16px; flex: 1; min-height: 0; overflow-y: auto; }
            .section { background: #252b3b; border-radius: 8px; overflow: hidden; flex-shrink: 0; }
            .section-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #2a3142; }
            .section-title { font-size: 13px; font-weight: 500; color: #8892a0; letter-spacing: 0.5px; }
            .section-timestamp { font-size: 11px; color: #6b7280; }
            .info-section .info-content { padding: 16px; }
            .info-layout { display: flex; gap: 16px; }
            .info-image-placeholder { width: 100px; min-height: 100px; background: #1a1f2e; border-radius: 8px; border: 1px solid #2a3142; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; flex-shrink: 0; }
            .info-image-placeholder svg { opacity: 0.5; }
            .image-label { font-size: 11px; color: #6b7280; font-weight: 500; }
            .info-table { flex: 1; border-collapse: collapse; font-size: 13px; }
            .info-table th, .info-table td { padding: 5px 8px; text-align: left; border-bottom: 1px solid rgba(42, 49, 66, 0.5); }
            .info-table th { color: #8892a0; font-weight: 400; white-space: nowrap; width: 70px; }
            .info-table td { color: #e0e6ed; font-weight: 500; }
            .info-table tr:last-child th, .info-table tr:last-child td { border-bottom: none; }
            .power-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: #2a3142; }
            .power-card { background: #252b3b; padding: 14px 16px; }
            .power-card-label { font-size: 11px; font-weight: 500; color: #8892a0; margin-bottom: 8px; letter-spacing: 0.3px; }
            .power-card-body { display: flex; align-items: baseline; gap: 2px; }
            .power-card-value { font-size: 24px; font-weight: 600; color: #e0e6ed; line-height: 1; }
            .power-card-unit { font-size: 12px; font-weight: 400; color: #8892a0; }
            .power-card[data-metric="batteryVolt"] .power-card-value { color: #3b82f6; }
            .chart-section { flex: 1; min-height: 280px; display: flex; flex-direction: column; }
            .tab-header { display: flex; gap: 4px; padding: 8px 16px; border-bottom: 1px solid #2a3142; flex-shrink: 0; }
            .tab-btn { padding: 6px 12px; background: transparent; border: none; border-radius: 6px; color: #8892a0; font-size: 12px; font-weight: 500; cursor: pointer; transition: background 0.15s, color 0.15s; }
            .tab-btn:hover { background: #252b3b; color: #e0e6ed; }
            .tab-btn.active { background: #3b82f6; color: #fff; }
            .chart-legend { display: flex; gap: 16px; padding: 8px 16px; flex-shrink: 0; }
            .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #8892a0; }
            .legend-dot { width: 10px; height: 3px; border-radius: 1px; }
            .legend-input .legend-dot { background: #f59e0b; }
            .legend-output .legend-dot { background: #22c55e; }
            .chart-container { flex: 1; min-height: 200px; width: 100%; }
            .empty-state { padding: 24px 16px; text-align: center; color: #6b7280; font-size: 13px; }
            .error-state { padding: 24px 16px; text-align: center; color: #ef4444; font-size: 13px; }
        `;

        // ======================
        // CONFIG는 initComponent 내부에서 this.config로 통합
        // ======================

        // ======================
        // MOCK IMPLEMENTATIONS
        // ======================
        const API_BASE = 'http://10.23.128.125:4004';

        const fx = {
            go: (data, ...fns) => fns.reduce((acc, fn) => acc.then ? acc.then(fn) : Promise.resolve(fn(acc)), Promise.resolve(data)),
            each: (fn, arr) => {
                if (arr === undefined) return (arr2) => { arr2.forEach(fn); return arr2; };
                arr.forEach(fn); return arr;
            },
            filter: (fn, arr) => {
                if (arr === undefined) return (arr2) => arr2.filter(fn);
                return arr.filter(fn);
            },
            reduce: (fn, init, arr) => {
                if (arr === undefined) return (arr2) => arr2.reduce(fn, init);
                return arr.reduce(fn, init);
            },
            map: (fn, arr) => {
                if (arr === undefined) return (arr2) => arr2.map(fn);
                return arr.map(fn);
            }
        };

        const Wkit = {
            bind3DEvents: (ctx, events) => console.log('[Wkit.bind3DEvents]', Object.keys(events)),
            fetchData: (page, datasetName, param) => {
                console.log('[Wkit.fetchData]', datasetName, param);
                return Promise.resolve({ response: { data: getMockData(datasetName, param) } });
            }
        };

        // Mock data
        let currentStatus = 'normal';

        // assetDetailUnified 응답
        const mockUPSData = {
            normal: {
                asset: {
                    name: 'UPS-A01',
                    assetType: 'UPS',
                    usageCode: '주전원',
                    locationLabel: '2층 전기실',
                    statusType: 'ACTIVE',
                    installDate: '2025-10-23',
                    assetModelKey: 'mdl-ups-001',
                    assetModelName: 'Galaxy 8000',
                },
            },
            warning: {
                asset: {
                    name: 'UPS-B02',
                    assetType: 'UPS',
                    usageCode: '보조전원',
                    locationLabel: '1층 전기실',
                    statusType: 'WARNING',
                    installDate: '2024-08-10',
                    assetModelKey: 'mdl-ups-002',
                    assetModelName: '9PX 8000',
                },
            },
            critical: {
                asset: {
                    name: 'UPS-C03',
                    assetType: 'UPS',
                    usageCode: '백업전원',
                    locationLabel: '지하 전기실',
                    statusType: 'CRITICAL',
                    installDate: '2023-11-01',
                    assetModelKey: 'mdl-ups-003',
                    assetModelName: 'SRT 10000',
                },
            }
        };

        // modelDetail 응답
        const mockModelData = {
            'mdl-ups-001': { name: 'Galaxy 8000', assetVendorKey: 'vdr-apc' },
            'mdl-ups-002': { name: '9PX 8000', assetVendorKey: 'vdr-eaton' },
            'mdl-ups-003': { name: 'SRT 10000', assetVendorKey: 'vdr-apc' },
        };

        // vendorDetail 응답
        const mockVendorData = {
            'vdr-apc': { name: 'APC by Schneider Electric' },
            'vdr-eaton': { name: 'Eaton' },
        };

        // metricLatest 응답 (전력현황 4카드)
        const mockMetricData = {
            normal: [
                { metricCode: 'UPS.BATT_PCT', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 85 },
                { metricCode: 'UPS.LOAD_PCT', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 45 },
                { metricCode: 'UPS.BATT_V', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 5400 },
            ],
            warning: [
                { metricCode: 'UPS.BATT_PCT', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 65 },
                { metricCode: 'UPS.LOAD_PCT', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 72 },
                { metricCode: 'UPS.BATT_V', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 5100 },
            ],
            critical: [
                { metricCode: 'UPS.BATT_PCT', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 25 },
                { metricCode: 'UPS.LOAD_PCT', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 95 },
                { metricCode: 'UPS.BATT_V', eventedAt: new Date().toISOString(), valueType: 'NUMBER', valueNumber: 3200 },
            ]
        };

        // metricHistoryStats 응답 생성 (24시간 시계열)
        function generateTrendData() {
            const now = new Date();
            const data = [];

            for (let i = 23; i >= 0; i--) {
                const time = new Date(now.getTime() - i * 3600000).toISOString();
                const hour = new Date(now.getTime() - i * 3600000).getHours();

                // 입력/출력 전류 (A)
                data.push({ time, metricCode: 'UPS.INPUT_A_SUM', statsBody: { sum: 14.5 + Math.random() * 2 - 1 } });
                data.push({ time, metricCode: 'UPS.OUTPUT_A_SUM', statsBody: { sum: 13.8 + Math.random() * 2 - 1 } });

                // 입력/출력 전압 (V)
                data.push({ time, metricCode: 'UPS.INPUT_V_AVG', statsBody: { avg: 220 + Math.random() * 6 - 3 } });
                data.push({ time, metricCode: 'UPS.OUTPUT_V_AVG', statsBody: { avg: 220 + Math.random() * 2 - 1 } });

                // 입력/출력 주파수 (Hz)
                data.push({ time, metricCode: 'UPS.INPUT_F_AVG', statsBody: { avg: 60 + Math.random() * 0.4 - 0.2 } });
                data.push({ time, metricCode: 'UPS.OUTPUT_F_AVG', statsBody: { avg: 60 + Math.random() * 0.1 - 0.05 } });
            }

            return data;
        }

        function getMockData(datasetName, param) {
            switch (datasetName) {
                case 'assetDetailUnified':
                    return mockUPSData[currentStatus];
                case 'metricLatest':
                    // 5초 갱신마다 약간 다른 값
                    const base = mockMetricData[currentStatus];
                    return base.map(m => ({
                        ...m,
                        eventedAt: new Date().toISOString(),
                        valueNumber: m.valueNumber + Math.floor(Math.random() * 100 - 50),
                    }));
                case 'modelDetail':
                    return mockModelData[param.assetModelKey] || null;
                case 'vendorDetail':
                    return mockVendorData[param.assetVendorKey] || null;
                case 'metricHistoryStats':
                    return generateTrendData();
                default:
                    return {};
            }
        }

        // Mock PopupMixin
        const PopupMixin = {
            applyShadowPopupMixin: (ctx, config) => {
                let shadowRoot = null;
                let _chart = null;

                ctx.showPopup = () => {
                    const host = ctx.page.element;
                    if (!host.shadowRoot) {
                        shadowRoot = host.attachShadow({ mode: 'open' });
                    } else {
                        shadowRoot = host.shadowRoot;
                        shadowRoot.innerHTML = '';
                    }

                    const style = document.createElement('style');
                    style.textContent = config.getStyles();
                    shadowRoot.appendChild(style);

                    const content = document.createElement('div');
                    content.innerHTML = config.getHTML();
                    shadowRoot.appendChild(content);

                    ctx._shadowRoot = shadowRoot;
                    config.onCreated?.();
                    console.log('[PopupMixin] Popup shown');
                };

                ctx.hidePopup = () => {
                    if (ctx._shadowRoot) {
                        ctx._shadowRoot.innerHTML = '';
                        console.log('[PopupMixin] Popup hidden');
                    }
                };

                ctx.destroyPopup = () => {
                    if (_chart) { _chart.dispose(); _chart = null; }
                    if (ctx._shadowRoot) {
                        ctx._shadowRoot.innerHTML = '';
                        ctx._shadowRoot = null;
                    }
                    console.log('[PopupMixin] Popup destroyed');
                };

                ctx.popupQuery = (sel) => ctx._shadowRoot?.querySelector(sel);
                ctx.popupQueryAll = (sel) => ctx._shadowRoot?.querySelectorAll(sel) || [];
                ctx.bindPopupEvents = (events) => {
                    Object.entries(events).forEach(([eventType, handlers]) => {
                        Object.entries(handlers).forEach(([selector, handler]) => {
                            ctx.popupQueryAll(selector).forEach(el => el.addEventListener(eventType, handler));
                        });
                    });
                };

                ctx._getChartRef = () => _chart;
                ctx._setChartRef = (c) => { _chart = c; };
            },

            applyEChartsMixin: (ctx) => {
                ctx.createChart = (selector) => {
                    const container = ctx.popupQuery(selector);
                    if (container) {
                        const chart = echarts.init(container);
                        ctx._setChartRef(chart);
                        console.log('[EChartsMixin] Chart created');
                    }
                };

                ctx.updateChart = (selector, option) => {
                    let chart = ctx._getChartRef();
                    if (!chart) {
                        const container = ctx.popupQuery(selector);
                        if (container) {
                            chart = echarts.init(container);
                            ctx._setChartRef(chart);
                        }
                    }
                    if (chart) {
                        chart.setOption(option);
                        console.log('[EChartsMixin] Chart updated');
                    }
                };
            }
        };

        // ======================
        // TEMPLATE HELPER
        // ======================
        function extractTemplate(htmlCode, templateId) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlCode, 'text/html');
            const template = doc.querySelector(`template#${templateId}`);
            return template?.innerHTML || '';
        }

        function hexToRgba(hex, alpha) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        }

        // ======================
        // COMPONENT INSTANCE
        // ======================
        let instance = null;

        function createInstance() {
            if (instance) { onInstanceUnLoad.call(instance); }

            instance = {
                id: 'preview-ups',
                page: { element: document.getElementById('popup-host') },
                properties: { publishCode: { htmlCode, cssCode } },
                setter: { assetInfo: { assetKey: 'mock-ups-001' } }
            };

            initComponent.call(instance);
            updateInstanceInfo();
        }

        function updateInstanceInfo() {
            const info = document.getElementById('instance-info');
            info.textContent = instance ? `Instance: ${instance.id}` : 'Instance: not created';
        }

        // ======================
        // COMPONENT LIFECYCLE (register.js와 동일)
        // ======================

        function initComponent() {
            const { bind3DEvents, fetchData } = Wkit;
            const { applyShadowPopupMixin, applyEChartsMixin } = PopupMixin;

            // ======================
            // 1. 내부 상태
            // ======================
            this._defaultAssetKey = this.setter?.assetInfo?.assetKey || this.id;
            this._baseUrl = '10.23.128.140:8811';
            this._locale = 'ko';
            this._popupTemplateId = 'popup-ups';
            this._trendData = null;
            this._activeTab = 'voltage';

            // ======================
            // 2. 변환 함수 바인딩 (config.fields.transform에서 사용)
            // ======================
            this.statusTypeToLabel = statusTypeToLabel.bind(this);       // 'ACTIVE' → '정상'
            this.statusTypeToDataAttr = statusTypeToDataAttr.bind(this); // 'ACTIVE' → 'normal' (CSS 선택자용)
            this.formatDate = formatDate.bind(this);                     // ISO → 'YYYY-MM-DD'
            this.formatTimestamp = formatTimestamp.bind(this);           // ISO → 'HH:mm:ss'

            // ======================
            // 3. Config 통합 (this.config로 모든 설정 접근)
            // ======================
            this.config = {
                // 데이터셋 이름
                datasetNames: {
                    assetDetail: 'assetDetailUnified',
                    metricLatest: 'metricLatest',
                    metricHistory: 'metricHistoryStats',
                    modelDetail: 'modelDetail',
                    vendorDetail: 'vendorDetail',
                },

                // 갱신 주기
                refresh: {
                    interval: 5000,
                },

                // API 엔드포인트 및 파라미터
                api: {
                    trendHistory: '/api/v1/mhs/l',
                    trendParams: {
                        interval: '1h',
                        timeRange: 24 * 60 * 60 * 1000,
                        metricCodes: [
                            'UPS.INPUT_A_SUM', 'UPS.OUTPUT_A_SUM',
                            'UPS.INPUT_V_AVG', 'UPS.OUTPUT_V_AVG',
                            'UPS.INPUT_F_AVG', 'UPS.OUTPUT_F_AVG',
                        ],
                        statsKeys: [],
                        timeField: 'time',
                    },
                    statsKeyMap: {
                        'UPS.INPUT_A_SUM': 'sum',
                        'UPS.OUTPUT_A_SUM': 'sum',
                        'UPS.INPUT_V_AVG': 'avg',
                        'UPS.OUTPUT_V_AVG': 'avg',
                        'UPS.INPUT_F_AVG': 'avg',
                        'UPS.OUTPUT_F_AVG': 'avg',
                    },
                },

                // 상태 코드별 레이블/속성 매핑
                statusMap: {
                    ACTIVE:      { label: '정상운영', dataAttr: 'normal' },
                    WARNING:     { label: '주의',     dataAttr: 'warning' },
                    CRITICAL:    { label: '위험',     dataAttr: 'critical' },
                    INACTIVE:    { label: '비활성',   dataAttr: 'inactive' },
                    MAINTENANCE: { label: '유지보수', dataAttr: 'maintenance' },
                    DEFAULT:     { label: '알 수 없음', dataAttr: 'normal' },
                },

                // ========================
                // UI 영역별 설정
                // ========================

                // 팝업 헤더 영역
                header: {
                    fields: [
                        { key: 'name', selector: '.ups-name' },
                        { key: 'locationLabel', selector: '.ups-zone' },
                        { key: 'statusType', selector: '.ups-status', transform: this.statusTypeToLabel },
                        { key: 'statusType', selector: '.ups-status', dataAttr: 'status', transform: this.statusTypeToDataAttr },
                    ],
                },

                // 기본정보 테이블 영역
                infoTable: {
                    fields: [
                        { key: 'name', selector: '.info-name' },
                        { key: 'assetType', selector: '.info-type' },
                        { key: 'assetModelName', selector: '.info-model', fallback: '-' },
                        { key: 'usageCode', selector: '.info-usage', fallback: '-' },
                        { key: 'locationLabel', selector: '.info-location' },
                        { key: 'statusType', selector: '.info-status', transform: this.statusTypeToLabel },
                        { key: 'installDate', selector: '.info-install-date', transform: this.formatDate },
                    ],
                    chain: {
                        vendor: '.info-vendor',
                    },
                },

                // 전력현황 영역 (4카드)
                powerStatus: {
                    metrics: {
                        batterySoc:   { label: '배터리 사용률',   unit: '%', metricCode: 'UPS.BATT_PCT', scale: 1.0 },
                        batteryTime:  { label: '배터리 잔여시간', unit: 'h', metricCode: null,          scale: 1.0 },  // API 미지원
                        loadRate:     { label: '부하율',         unit: '%', metricCode: 'UPS.LOAD_PCT', scale: 1.0 },
                        batteryVolt:  { label: '배터리 출력전압', unit: 'V', metricCode: 'UPS.BATT_V',   scale: 1.0 },
                    },
                    selectors: {
                        card: '.power-card',
                        label: '.power-card-label',
                        value: '.power-card-value',
                        unit: '.power-card-unit',
                        timestamp: '.section-timestamp',
                    },
                },

                // 트렌드 차트 영역 (3탭)
                chart: {
                    tabs: {
                        current:   { label: '입/출력 전류',   unit: 'A',  inputCode: 'UPS.INPUT_A_SUM',  outputCode: 'UPS.OUTPUT_A_SUM' },
                        voltage:   { label: '입/출력 전압',   unit: 'V',  inputCode: 'UPS.INPUT_V_AVG',  outputCode: 'UPS.OUTPUT_V_AVG' },
                        frequency: { label: '입/출력 주파수', unit: 'Hz', inputCode: 'UPS.INPUT_F_AVG',  outputCode: 'UPS.OUTPUT_F_AVG' },
                    },
                    series: {
                        input:  { label: '입력', color: '#f59e0b' },
                        output: { label: '출력', color: '#22c55e' },
                    },
                    selectors: {
                        container: '.chart-container',
                        tabBtn: '.tab-btn',
                        legendInput: '.legend-input .legend-label',
                        legendOutput: '.legend-output .legend-label',
                    },
                },
            };

            // ======================
            // 4. 데이터셋 정의
            // ======================
            const { datasetNames, api } = this.config;
            const baseParam = { baseUrl: this._baseUrl, assetKey: this._defaultAssetKey, locale: this._locale };
            this.datasetInfo = [
                { datasetName: datasetNames.assetDetail, param: { ...baseParam }, render: ['renderBasicInfo'], refreshInterval: 0 },
                { datasetName: datasetNames.metricLatest, param: { ...baseParam }, render: ['renderPowerStatus'], refreshInterval: 5000 },
                { datasetName: datasetNames.metricHistory, param: { ...baseParam, ...api.trendParams, apiEndpoint: api.trendHistory }, render: ['renderTrendChart'], refreshInterval: 5000 },
            ];

            // ======================
            // 5. 렌더링 함수 바인딩
            // ======================
            this.renderBasicInfo = renderBasicInfo.bind(this);
            this.renderPowerStatus = renderPowerStatus.bind(this);
            this.renderTrendChart = renderTrendChart.bind(this);
            this.renderInitialLabels = renderInitialLabels.bind(this);

            // ======================
            // 6. Public Methods
            // ======================
            this.showDetail = showDetail.bind(this);
            this.hideDetail = hideDetail.bind(this);
            this.stopRefresh = stopRefresh.bind(this);
            this._switchTab = switchTab.bind(this);

            // ======================
            // 7. 3D 이벤트 바인딩 (라이브러리 강제 네이밍)
            // ======================
            this.customEvents = {
                click: '@assetClicked',
            };

            bind3DEvents(this, this.customEvents);

            // ======================
            // 8. Popup (template 기반)
            // ======================
            const popupCreatedConfig = {
                chartSelector: this.config.chart.selectors.container,
                events: {
                    click: {
                        '.close-btn': () => this.hideDetail(),
                        '.tab-btn': (e) => this._switchTab(e.target.dataset.tab),
                    },
                },
            };

            const { htmlCode, cssCode } = this.properties.publishCode || {};
            this.getPopupHTML = () => extractTemplate(htmlCode || '', this._popupTemplateId);
            this.getPopupStyles = () => cssCode || '';
            this.onPopupCreated = onPopupCreated.bind(this, popupCreatedConfig);

            applyShadowPopupMixin(this, {
                getHTML: this.getPopupHTML,
                getStyles: this.getPopupStyles,
                onCreated: this.onPopupCreated,
            });

            applyEChartsMixin(this);

            console.log('[UPS] Registered:', this._defaultAssetKey);
        }

        function showDetail() {
            this.showPopup();

            // 탭 상태 초기화
            this._activeTab = 'voltage';
            const tabBtns = this.popupQueryAll(this.config.chart.selectors.tabBtn);
            if (tabBtns) {
                tabBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.tab === 'voltage'));
            }

            // 모든 datasetInfo를 fetchData로 호출
            fx.go(
                this.datasetInfo,
                fx.each(d => fetchDatasetAndRender.call(this, d))
            );

            // refreshInterval > 0인 데이터셋에 대해 주기적 갱신 시작
            this.stopRefresh();
            fx.go(
                this.datasetInfo,
                fx.filter(d => d.refreshInterval > 0),
                fx.each(d => {
                    d._intervalId = setInterval(() => fetchDatasetAndRender.call(this, d), d.refreshInterval);
                })
            );
        }

        function hideDetail() {
            this.stopRefresh();
            this.hidePopup();
        }

        function stopRefresh() {
            fx.go(
                this.datasetInfo,
                fx.filter(d => d._intervalId),
                fx.each(d => {
                    clearInterval(d._intervalId);
                    d._intervalId = null;
                })
            );
        }

        // ======================
        // DATASET FETCH HELPER
        // ======================

        function formatLocalDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            const s = String(date.getSeconds()).padStart(2, '0');
            return y + '-' + m + '-' + d + ' ' + h + ':' + min + ':' + s;
        }

        function fetchDatasetAndRender(d) {
            const { datasetNames } = this.config;
            const { datasetName, param, render } = d;

            // metricHistory는 매번 timeFrom/timeTo 갱신
            if (datasetName === datasetNames.metricHistory) {
                const now = new Date();
                const from = new Date(now.getTime() - param.timeRange);
                param.timeFrom = formatLocalDate(from);
                param.timeTo = formatLocalDate(now);
            }

            Wkit.fetchData(this.page, datasetName, param)
                .then(response => {
                    const data = extractData(response);
                    if (!data) return;
                    if (datasetName === datasetNames.metricHistory) {
                        this._trendData = data;
                    }
                    fx.each(fn => this[fn](response), render);
                })
                .catch(e => console.warn(`[UPS] ${datasetName} fetch failed:`, e));
        }

        function switchTab(tabName) {
            const { chart } = this.config;
            if (!tabName || !chart.tabs[tabName]) return;
            this._activeTab = tabName;

            const buttons = this.popupQueryAll(chart.selectors.tabBtn);
            if (buttons) {
                buttons.forEach((btn) => btn.classList.toggle('active', btn.dataset.tab === tabName));
            }

            // 이미 로드된 데이터로 차트 갱신
            if (this._trendData) {
                this.renderTrendChart({ response: { data: this._trendData } });
            }
        }

        /**
         * extractData - 응답 객체에서 데이터 추출
         */
        function extractData(response, path = 'data') {
            if (!response || !response.response) return null;
            const data = response.response[path];
            if (data === null || data === undefined) return null;
            return data;
        }

        function renderBasicInfo({ response }) {
            const { data } = response;
            if (!data || !data.asset) {
                console.warn('[UPS] renderBasicInfo: no asset data');
                return;
            }

            const asset = data.asset;
            const { header, infoTable } = this.config;

            // Header 영역
            fx.go(
                header.fields,
                fx.each(field => renderField(this, asset, field))
            );

            // 기본정보 테이블
            fx.go(
                infoTable.fields,
                fx.each(field => renderField(this, asset, field))
            );

            // 제조사명/모델 체이닝
            fetchModelVendorChain(this, asset, infoTable.chain);
        }

        function renderField(ctx, data, field) {
            const el = ctx.popupQuery(field.selector);
            if (!el) return;
            let value = data[field.key] ?? field.fallback ?? '-';
            if (field.transform) value = field.transform(value);
            if (field.dataAttr) {
                el.dataset[field.dataAttr] = value;
            } else {
                el.textContent = value;
            }
        }

        function fetchModelVendorChain(ctx, asset, chainConfig) {
            const { datasetNames } = ctx.config;
            const setCell = (selector, value) => {
                const el = ctx.popupQuery(selector);
                if (el) el.textContent = value ?? '-';
            };

            if (!asset.assetModelKey) return;

            fx.go(
                Wkit.fetchData(ctx.page, datasetNames.modelDetail, { baseUrl: ctx._baseUrl, assetModelKey: asset.assetModelKey }),
                (modelResp) => {
                    const model = extractData(modelResp, 'data');
                    if (!model) return;

                    if (model.assetVendorKey) {
                        fx.go(
                            Wkit.fetchData(ctx.page, datasetNames.vendorDetail, { baseUrl: ctx._baseUrl, assetVendorKey: model.assetVendorKey }),
                            (vendorResp) => {
                                const vendor = extractData(vendorResp, 'data');
                                if (vendor) setCell(chainConfig.vendor, vendor.name);
                            }
                        ).catch(() => {});
                    }
                }
            ).catch(() => {});
        }

        function renderPowerStatus({ response }) {
            const { data } = response;
            const { powerStatus } = this.config;
            const { metrics, selectors } = powerStatus;

            if (!data || !Array.isArray(data) || data.length === 0) {
                console.warn('[UPS] renderPowerStatus: no data');
                return;
            }

            // 타임스탬프 표시
            const timestampEl = this.popupQuery(selectors.timestamp);
            if (timestampEl && data[0]?.eventedAt) {
                timestampEl.textContent = this.formatTimestamp(data[0].eventedAt);
            }

            // 메트릭 코드 → 값 매핑
            const metricMap = fx.reduce(
                (acc, m) => (acc[m.metricCode] = m.valueType === 'NUMBER' ? m.valueNumber : m.valueString, acc),
                {},
                data
            );

            // 카드 업데이트
            fx.go(
                Object.entries(metrics),
                fx.each(([key, cfg]) => updatePowerCard(this, selectors, metricMap, key, cfg))
            );
        }

        function updatePowerCard(ctx, selectors, metricMap, key, cfg) {
            const card = ctx.popupQuery(`${selectors.card}[data-metric="${key}"]`);
            const valueEl = card?.querySelector(selectors.value);
            if (!valueEl) return;

            if (!cfg.metricCode) {
                valueEl.textContent = '-';
                return;
            }

            const rawValue = metricMap[cfg.metricCode];
            valueEl.textContent = rawValue != null ? (rawValue * cfg.scale).toFixed(1) : '-';
        }

        function renderTrendChart({ response }) {
            const { data } = response;
            const { chart } = this.config;
            const { tabs, series, selectors } = chart;
            const tabConfig = tabs[this._activeTab];
            if (!tabConfig) return;

            // 단일 시리즈 렌더링 (데이터 없어도 빈 차트 표시)
            const safeData = Array.isArray(data) ? data : [];
            const { datasetNames } = this.config;
            const trendInfo = this.datasetInfo.find((d) => d.datasetName === datasetNames.metricHistory);
            const { timeField } = trendInfo?.param || {};
            const timeKey = timeField || 'time';

            // 현재 탭의 metricCode로 필터링
            const tabMetricCodes = [tabConfig.inputCode, tabConfig.outputCode];
            const tabData = safeData.filter(row => tabMetricCodes.includes(row.metricCode));

            // 필터링된 데이터로 시간별 그룹핑
            const timeMap = fx.reduce(
                (acc, row) => {
                    const time = row[timeKey];
                    if (!acc[time]) acc[time] = {};
                    const statsKey = this.config.api.statsKeyMap[row.metricCode];
                    acc[time][row.metricCode] = statsKey ? (row.statsBody?.[statsKey] ?? null) : null;
                    return acc;
                },
                {},
                tabData
            );

            const times = Object.keys(timeMap);

            const extractValues = (code) => fx.map(t => {
                const raw = timeMap[t]?.[code];
                return raw != null ? +(raw).toFixed(2) : null;
            }, times);

            const inputValues = extractValues(tabConfig.inputCode);
            const outputValues = extractValues(tabConfig.outputCode);

            const { input: inputSeries, output: outputSeries } = series;

            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(26, 31, 46, 0.95)',
                    borderColor: '#2a3142',
                    textStyle: { color: '#e0e6ed', fontSize: 12 },
                },
                legend: {
                    data: [inputSeries.label, outputSeries.label],
                    top: 8,
                    textStyle: { color: '#8892a0', fontSize: 11 },
                },
                grid: { left: 50, right: 20, top: 40, bottom: 24 },
                xAxis: {
                    type: 'category',
                    data: times,
                    axisLine: { lineStyle: { color: '#333' } },
                    axisLabel: { color: '#888', fontSize: 10 },
                },
                yAxis: {
                    type: 'value',
                    name: tabConfig.unit,
                    axisLine: { show: true, lineStyle: { color: '#666' } },
                    axisLabel: { color: '#888', fontSize: 10 },
                    splitLine: { lineStyle: { color: '#333' } },
                },
                series: [
                    {
                        name: inputSeries.label,
                        type: 'line',
                        data: inputValues,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { color: inputSeries.color, width: 2 },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: hexToRgba(inputSeries.color, 0.2) },
                                    { offset: 1, color: hexToRgba(inputSeries.color, 0) },
                                ],
                            },
                        },
                    },
                    {
                        name: outputSeries.label,
                        type: 'line',
                        data: outputValues,
                        smooth: true,
                        symbol: 'none',
                        lineStyle: { color: outputSeries.color, width: 2 },
                        areaStyle: {
                            color: {
                                type: 'linear',
                                x: 0, y: 0, x2: 0, y2: 1,
                                colorStops: [
                                    { offset: 0, color: hexToRgba(outputSeries.color, 0.2) },
                                    { offset: 1, color: hexToRgba(outputSeries.color, 0) },
                                ],
                            },
                        },
                    },
                ],
            };

            this.updateChart(selectors.container, option);
        }

        function renderError(message) {
            const nameEl = this.popupQuery('.ups-name');
            const zoneEl = this.popupQuery('.ups-zone');
            const statusEl = this.popupQuery('.ups-status');

            if (nameEl) nameEl.textContent = '데이터 없음';
            if (zoneEl) zoneEl.textContent = message;
            if (statusEl) {
                statusEl.textContent = 'Error';
                statusEl.dataset.status = 'critical';
            }

            console.warn('[UPS] renderError:', message);
        }

        function onPopupCreated({ chartSelector, events }) {
            chartSelector && this.createChart(chartSelector);
            events && this.bindPopupEvents(events);
            this.renderInitialLabels();
        }

        function renderInitialLabels() {
            const { powerStatus, chart } = this.config;
            const { metrics, selectors } = powerStatus;
            const container = this.popupQuery('.power-cards');

            // 전력현황 카드 reconciliation: config 기준으로 DOM 동기화
            fx.go(
                Object.entries(metrics),
                fx.each(([key, cfg]) => {
                    let card = this.popupQuery(`${selectors.card}[data-metric="${key}"]`);
                    if (!card && container) {
                        card = createPowerCardElement(key);
                        container.appendChild(card);
                    }
                    if (!card) return;
                    const labelEl = card.querySelector(selectors.label);
                    const unitEl = card.querySelector(selectors.unit);
                    if (labelEl) labelEl.textContent = cfg.label;
                    if (unitEl) unitEl.textContent = cfg.unit;
                })
            );

            // DOM에 있지만 config에 없는 카드 제거
            if (container) {
                container.querySelectorAll(selectors.card).forEach(card => {
                    if (!metrics[card.dataset.metric]) card.remove();
                });
            }

            // 탭 버튼 라벨
            fx.go(
                Object.entries(chart.tabs),
                fx.each(([key, cfg]) => {
                    const btn = this.popupQuery(`${chart.selectors.tabBtn}[data-tab="${key}"]`);
                    if (btn) btn.textContent = cfg.label;
                })
            );

            // 범례 라벨
            const inputLegend = this.popupQuery(chart.selectors.legendInput);
            const outputLegend = this.popupQuery(chart.selectors.legendOutput);
            if (inputLegend) inputLegend.textContent = chart.series.input.label;
            if (outputLegend) outputLegend.textContent = chart.series.output.label;
        }

        function createPowerCardElement(key) {
            const card = document.createElement('div');
            card.className = 'power-card';
            card.dataset.metric = key;
            card.innerHTML = `
                <div class="power-card-label"></div>
                <div class="power-card-body">
                    <span class="power-card-value">-</span>
                    <span class="power-card-unit"></span>
                </div>
            `;
            return card;
        }

        function statusTypeToLabel(statusType) {
            const { statusMap } = this.config;
            const entry = statusMap[statusType] || statusMap.DEFAULT;
            return entry.label;
        }

        function statusTypeToDataAttr(statusType) {
            const { statusMap } = this.config;
            const entry = statusMap[statusType] || statusMap.DEFAULT;
            return entry.dataAttr;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
            } catch { return dateStr; }
        }

        function formatTimestamp(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            } catch { return ''; }
        }

        function onInstanceUnLoad() {
            this.stopRefresh();
            this.destroyPopup();

            // 캐시 데이터 해제
            this._trendData = null;

            console.log('[UPS] Destroyed:', this.id);
        }

        // ======================
        // PREVIEW CONTROLS
        // ======================

        function showNormal() {
            currentStatus = 'normal';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function showWarning() {
            currentStatus = 'warning';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function showCritical() {
            currentStatus = 'critical';
            if (!instance) createInstance();
            instance.showDetail();
        }

        function destroyInstance() {
            if (instance) {
                onInstanceUnLoad.call(instance);
                instance = null;
                updateInstanceInfo();
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskMonitor - Preview</title>

    <!-- External Libraries -->
    <link href="https://unpkg.com/tabulator-tables@6.3.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script src="https://unpkg.com/tabulator-tables@6.3.1/dist/js/tabulator.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <!-- Page Styles -->
    <link rel="stylesheet" href="master/page/page_styles/container.css">
    <link rel="stylesheet" href="page/page_styles/container.css">

    <!-- Component Styles -->
    <link rel="stylesheet" href="master/page/components/Header/styles/component.css">
    <link rel="stylesheet" href="master/page/components/Sidebar/styles/component.css">
    <link rel="stylesheet" href="page/components/TaskList/styles/component.css">
    <link rel="stylesheet" href="page/components/StatusChart/styles/component.css">
    <link rel="stylesheet" href="page/components/ActivityLog/styles/component.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <!-- Page Container -->
    <div id="page-container">
        <!-- TaskList (views/component.html) -->
        <div id="task-list-container">
            <div class="task-list">
                <div class="task-list-header">
                    <h3 class="section-title">Tasks</h3>
                    <div class="task-count">
                        <span class="count-value">0</span> tasks
                    </div>
                </div>
                <div class="table-container"></div>
            </div>
        </div>

        <!-- StatusChart (views/component.html) -->
        <div id="status-chart-container">
            <div class="status-chart">
                <div class="chart-header">
                    <h3 class="section-title">Status Overview</h3>
                    <span class="total-count">Total: <strong>0</strong></span>
                </div>
                <div class="chart-container"></div>
            </div>
        </div>

        <!-- ActivityLog (views/component.html) -->
        <div id="activity-log-container">
            <div class="activity-log">
                <div class="log-header">
                    <h3 class="section-title">Recent Activity</h3>
                    <span class="activity-count">
                        <span class="count-value">0</span> events
                    </span>
                </div>
                <div class="log-list"></div>
            </div>
        </div>
    </div>

    <!-- Master Container (DOM ÏïÑÎûòÏóê ÏúÑÏπò = Î†àÏù¥Ïñ¥ ÏúÑ) -->
    <div id="master-container">
        <!-- Header (views/component.html) -->
        <div id="header-container">
            <div class="header">
                <div class="header-left">
                    <h1 class="app-title">TaskMonitor</h1>
                    <span class="app-version"></span>
                </div>
                <div class="header-center">
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span class="status-text">Connecting...</span>
                    </div>
                    <div class="task-summary">
                        <span class="total-tasks">0</span> tasks
                        <span class="separator">|</span>
                        <span class="active-tasks">0</span> active
                    </div>
                </div>
                <div class="header-right">
                    <button class="btn-refresh" title="Refresh All">
                        <span class="refresh-icon">‚Üª</span>
                    </button>
                    <span class="last-sync"></span>
                </div>
            </div>
        </div>

        <!-- Sidebar (views/component.html) -->
        <div id="sidebar-container">
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Filters</h3>
                </div>
                <div class="sidebar-content">
                    <div class="filter-group">
                        <label class="filter-label">Status</label>
                        <select class="filter-select" data-filter="status">
                            <option value="all">All Status</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Priority</label>
                        <select class="filter-select" data-filter="priority">
                            <option value="all">All Priorities</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Type</label>
                        <select class="filter-select" data-filter="type">
                            <option value="all">All Types</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Assignee</label>
                        <select class="filter-select" data-filter="assignee">
                            <option value="all">All Assignees</option>
                        </select>
                    </div>
                </div>
                <div class="sidebar-footer">
                    <button class="btn-apply">Apply Filters</button>
                    <button class="btn-reset">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://10.23.128.125:4004';

        // ============================================
        // Data Fetching
        // ============================================

        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`);
                return await response.json();
            } catch (error) {
                console.error(`[Fetch Error] ${endpoint}:`, error);
                return null;
            }
        }

        // ============================================
        // Header (register.js Î°úÏßÅ)
        // ============================================

        function renderAppInfo(data) {
            const root = document.getElementById('header-container');

            // App version
            const versionEl = root.querySelector('.app-version');
            if (versionEl) versionEl.textContent = `v${data.version}`;

            // Server status
            const statusDot = root.querySelector('.status-dot');
            const statusText = root.querySelector('.status-text');
            if (statusDot && statusText) {
                const isHealthy = data.serverStatus === 'healthy';
                statusDot.classList.toggle('healthy', isHealthy);
                statusText.textContent = isHealthy ? 'Connected' : 'Disconnected';
            }

            // Task summary
            const totalEl = root.querySelector('.total-tasks');
            const activeEl = root.querySelector('.active-tasks');
            if (totalEl) totalEl.textContent = data.totalTasks;
            if (activeEl) activeEl.textContent = data.activeTasks;

            // Last sync
            const syncEl = root.querySelector('.last-sync');
            if (syncEl && data.lastSync) {
                const date = new Date(data.lastSync);
                syncEl.textContent = `Last sync: ${date.toLocaleTimeString()}`;
            }

            console.log('[Header] App info rendered');
        }

        async function fetchAndRenderHeader() {
            const result = await fetchData('/api/app-info');
            if (result?.data) renderAppInfo(result.data);
        }

        // ============================================
        // Sidebar (register.js Î°úÏßÅ)
        // ============================================

        let _currentFilters = {
            status: 'all',
            priority: 'all',
            type: 'all',
            assignee: 'all'
        };

        function populateSelect(selectEl, options) {
            if (!selectEl || !options) return;
            selectEl.innerHTML = options.map(opt =>
                `<option value="${opt.value}">${opt.label}</option>`
            ).join('');
        }

        function renderFilters(data) {
            const root = document.getElementById('sidebar-container');

            populateSelect(root.querySelector('[data-filter="status"]'), data.statuses);
            populateSelect(root.querySelector('[data-filter="priority"]'), data.priorities);
            populateSelect(root.querySelector('[data-filter="type"]'), data.types);
            populateSelect(root.querySelector('[data-filter="assignee"]'), data.assignees);

            console.log('[Sidebar] Filters rendered');
        }

        async function fetchAndRenderSidebar() {
            const result = await fetchData('/api/filters');
            if (result?.data) renderFilters(result.data);
        }

        function setupSidebarEvents() {
            const root = document.getElementById('sidebar-container');

            // ÏÖÄÎ†âÌä∏ Î≥ÄÍ≤Ω
            root.querySelectorAll('.filter-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const filterType = e.target.dataset.filter;
                    if (filterType) {
                        _currentFilters[filterType] = e.target.value;
                    }
                });
            });

            // Apply Î≤ÑÌäº
            root.querySelector('.btn-apply')?.addEventListener('click', () => {
                console.log('[Sidebar] @filterApplied:', _currentFilters);
                fetchAndRenderTaskList();
            });

            // Reset Î≤ÑÌäº
            root.querySelector('.btn-reset')?.addEventListener('click', () => {
                _currentFilters = { status: 'all', priority: 'all', type: 'all', assignee: 'all' };
                root.querySelectorAll('.filter-select').forEach(select => {
                    select.value = 'all';
                });
                console.log('[Sidebar] @filterReset');
                fetchAndRenderTaskList();
            });
        }

        // ============================================
        // TaskList (register.js Î°úÏßÅ)
        // ============================================

        let _tableInstance = null;

        const tableConfig = {
            layout: 'fitColumns',
            height: '100%',
            placeholder: 'No tasks found',
            selectable: 1,
            columns: [
                { title: 'ID', field: 'id', width: 100, headerSort: true },
                { title: 'Title', field: 'title', widthGrow: 2, headerSort: true },
                { title: 'Type', field: 'type', width: 120, headerSort: true,
                    formatter: cell => {
                        const value = cell.getValue();
                        return value.charAt(0).toUpperCase() + value.slice(1);
                    }
                },
                { title: 'Status', field: 'status', width: 120, headerSort: true,
                    formatter: cell => {
                        const value = cell.getValue();
                        const labels = { pending: 'Pending', in_progress: 'In Progress', completed: 'Completed', failed: 'Failed' };
                        return `<span class="status-badge" data-status="${value}">${labels[value] || value}</span>`;
                    }
                },
                { title: 'Priority', field: 'priority', width: 100, headerSort: true,
                    formatter: cell => {
                        const value = cell.getValue();
                        const labels = { low: 'Low', medium: 'Medium', high: 'High', critical: 'Critical' };
                        return `<span class="priority-badge" data-priority="${value}">${labels[value] || value}</span>`;
                    }
                },
                { title: 'Assignee', field: 'assignee', width: 100, headerSort: true },
                { title: 'Progress', field: 'progress', width: 140, headerSort: true,
                    formatter: cell => {
                        const value = cell.getValue();
                        return `
                            <div class="progress-cell">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${value}%"></div>
                                </div>
                                <span class="progress-text">${value}%</span>
                            </div>
                        `;
                    }
                }
            ]
        };

        function initTable() {
            const container = document.querySelector('#task-list-container .table-container');
            if (!container || _tableInstance) return;

            container.id = 'tabulator-tasks';
            _tableInstance = new Tabulator('#tabulator-tasks', tableConfig);

            _tableInstance.on('rowClick', (_, row) => {
                console.log('[TaskList] @taskClicked:', row.getData());
            });
        }

        function renderTable(data, meta) {
            const root = document.getElementById('task-list-container');

            // Update count
            const countEl = root.querySelector('.count-value');
            if (countEl) {
                countEl.textContent = meta?.total ?? data.length;
            }

            // Update table
            if (_tableInstance) {
                _tableInstance.setData(data);
            }

            console.log('[TaskList] Table rendered:', meta);
        }

        async function fetchAndRenderTaskList() {
            const params = new URLSearchParams(_currentFilters).toString();
            const result = await fetchData(`/api/tasks?${params}`);
            if (result?.data) renderTable(result.data, result.meta);
        }

        // ============================================
        // StatusChart (register.js Î°úÏßÅ)
        // ============================================

        let _chartInstance = null;
        let _resizeObserver = null;

        function getChartOption(data) {
            return {
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    right: 20,
                    top: 'center',
                    itemWidth: 12,
                    itemHeight: 12,
                    textStyle: { fontSize: 13, color: '#64748b' }
                },
                series: [{
                    type: 'pie',
                    radius: ['45%', '70%'],
                    center: ['35%', '50%'],
                    avoidLabelOverlap: false,
                    itemStyle: { borderRadius: 4, borderColor: '#fff', borderWidth: 2 },
                    label: { show: false },
                    emphasis: {
                        label: { show: true, fontSize: 14, fontWeight: 'bold' }
                    },
                    data: data.byStatus.map(item => ({
                        name: item.name,
                        value: item.value,
                        itemStyle: { color: item.color }
                    }))
                }]
            };
        }

        function initChart() {
            const container = document.querySelector('#status-chart-container .chart-container');
            if (!container || _chartInstance) return;

            _chartInstance = echarts.init(container);

            _resizeObserver = new ResizeObserver(() => {
                _chartInstance?.resize();
            });
            _resizeObserver.observe(container);
        }

        function renderChart(data) {
            const root = document.getElementById('status-chart-container');

            // Update total count
            const totalEl = root.querySelector('.total-count strong');
            if (totalEl) {
                totalEl.textContent = data.total;
            }

            // Update chart
            if (_chartInstance) {
                const option = getChartOption(data);
                _chartInstance.setOption(option, true);
            }

            console.log('[StatusChart] Chart rendered');
        }

        async function fetchAndRenderStatusChart() {
            const result = await fetchData('/api/status');
            if (result?.data) renderChart(result.data);
        }

        // ============================================
        // ActivityLog (register.js Î°úÏßÅ)
        // ============================================

        const ACTION_ICONS = {
            created: '+',
            updated: '‚Üª',
            completed: '‚úì',
            assigned: '‚Üí',
            commented: 'üí¨'
        };

        const ACTION_MESSAGES = {
            created: (item) => `<span class="user-name">${item.user}</span> created <span class="task-id">${item.taskId}</span>`,
            updated: (item) => `<span class="user-name">${item.user}</span> updated <span class="task-id">${item.taskId}</span>`,
            completed: (item) => `<span class="user-name">${item.user}</span> completed <span class="task-id">${item.taskId}</span>`,
            assigned: (item) => `<span class="task-id">${item.taskId}</span> assigned to <span class="user-name">${item.user}</span>`,
            commented: (item) => `<span class="user-name">${item.user}</span> commented on <span class="task-id">${item.taskId}</span>`
        };

        function formatRelativeTime(timestamp) {
            const now = new Date();
            const time = new Date(timestamp);
            const diff = Math.floor((now - time) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return time.toLocaleDateString();
        }

        function renderActivity(data, meta) {
            const root = document.getElementById('activity-log-container');

            // Update count
            const countEl = root.querySelector('.count-value');
            if (countEl) {
                countEl.textContent = meta?.count ?? data.length;
            }

            // Render log items
            const listEl = root.querySelector('.log-list');
            if (!listEl) return;

            listEl.innerHTML = data.map(item => {
                const icon = ACTION_ICONS[item.action] || '‚Ä¢';
                const message = ACTION_MESSAGES[item.action]?.(item) || `${item.user} ${item.action} ${item.taskId}`;
                const time = formatRelativeTime(item.timestamp);

                return `
                    <div class="log-item">
                        <div class="log-icon" data-action="${item.action}">${icon}</div>
                        <div class="log-content">
                            <div class="log-message">${message}</div>
                            <div class="log-time">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('[ActivityLog] Activity rendered:', meta);
        }

        async function fetchAndRenderActivityLog() {
            const result = await fetchData('/api/activity?limit=10');
            if (result?.data) renderActivity(result.data, result.meta);
        }

        // ============================================
        // Refresh All (@refreshAllClicked)
        // ============================================

        async function refreshAll() {
            console.log('[Dashboard] @refreshAllClicked');
            await Promise.all([
                fetchAndRenderHeader(),
                fetchAndRenderTaskList(),
                fetchAndRenderStatusChart(),
                fetchAndRenderActivityLog()
            ]);
        }

        // ============================================
        // Initialize
        // ============================================

        async function initDashboard() {
            console.log('[Dashboard] Initializing...');

            // Setup events
            document.querySelector('.btn-refresh')?.addEventListener('click', refreshAll);
            setupSidebarEvents();

            // Init components
            initTable();
            initChart();

            // Initial data fetch
            await Promise.all([
                fetchAndRenderHeader(),
                fetchAndRenderSidebar(),
                fetchAndRenderTaskList(),
                fetchAndRenderStatusChart(),
                fetchAndRenderActivityLog()
            ]);

            // Auto-refresh intervals (globalDataMappings Ï£ºÍ∏∞ÏôÄ ÎèôÏùº)
            setInterval(fetchAndRenderTaskList, 10000);      // tasks: 10s
            setInterval(fetchAndRenderStatusChart, 15000);   // statusSummary: 15s
            setInterval(fetchAndRenderActivityLog, 8000);    // activity: 8s

            console.log('[Dashboard] Initialized');
        }

        initDashboard();
    </script>
</body>
</html>
